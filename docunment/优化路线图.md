# Poor Server STL 项目优化路线图

> **文档版本**: v1.3.2  
> **创建日期**: 2024年  
> **最后更新**: 2025年12月（Connection Pool Timeout Update）  
> **适用项目阶段**: 阶段1已完成，进入阶段2 Skynet集成

---

## 📋 目录

- [项目现状评估](#项目现状评估)
- [核心问题分析](#核心问题分析)
- [技术债务追踪](#技术债务追踪)
- [优化路线图](#优化路线图)
- [详细实施计划](#详细实施计划)
- [时间规划](#时间规划)
- [参考资料](#参考资料)

---

## 🎯 文档目的

本文档旨在：

1. **评估项目当前状态** - 识别已完成的工作和存在的问题
2. **规划优化方向** - 提供清晰的改进路线图
3. **指导开发工作** - 为后续开发提供可执行的计划
4. **追踪进度** - 便于检查优化工作的完成情况

---

## 🚀 快速开始指南

### 项目当前状态（2025年12月）

**✅ 已完成的重大里程碑**：

```
阶段 1：代码重构 ✅ 已完成
├── ✅ BaseServer 基类实现
│   ├── 统一服务器注册/注销
│   ├── 统一心跳发送
│   ├── 统一线程池管理
│   └── 所有8个服务器已迁移
│
├── ✅ ThreadManager 改进
│   ├── 修复编译警告
│   ├── 增强线程池功能
│   └── 所有服务器已使用
│
└── ✅ ConfigManager 实现
    ├── 统一配置文件读取
    ├── 支持多路径查找
    └── 所有 main.cpp 已迁移

技术债务偿还成果：
├── 重复代码从 ~2000行 减少到 ~200行 ✅
├── 代码重复率从 13% 降低到 <2% ✅
├── 未使用工具类从 3个 减少到 0个 ✅
└── 新增服务器开发时间减少 75% ✅
```

**🔄 当前进行中**：

```
阶段 2：Skynet 集成 🟡 进行中（已完成约 66%）
└── C++ 端 SkynetBridge（skynet_client / skynet_bridge） 已实现并集成到 Gateway
    ├── Skynet 编译与 .so 库问题已处理
    ├── 启动/管理脚本（manage_services、compile_guide、diagnose/fix 脚本）已完善
    ├── 文档（quick_start、troubleshooting、path_fix 等）已补全
    ├── 中央服务器连接池助手与匹配服务器池同步已完成
    ├── 通用连接池新增超时/空指针防护，支持异常返回
    └── Lua 端桥接（cpp_bridge.lua / cpp_gateway.lua）和完整 Protobuf 回路仍在开发中
```

---

### 如果你只有 10 分钟

**推荐阅读**：
1. 📊 [阶段1完成总结](#阶段1完成总结) - 了解已完成的工作
2. 🎯 [下一步行动](#下一步行动) - 查看接下来该做什么

**核心结论**：
- ✅ **阶段1成果**：2000+ 行重复代码已消除
- 🔄 **当前任务**：Skynet 集成（阶段2），C++ 端已就绪，Lua 端与消息协议对接中
- 🚀 **立即开始**：完成 Lua 端桥接、Protobuf 双向集成、示例服务测试

---

## 🎊 阶段1完成总结

### 主要成果

**代码重构成果**：

```
✅ BaseServer 基类实现
├── 文件位置：src/common/base_server.h/cpp
├── 代码行数：~500 行
├── 功能：
│   ├── 统一线程池管理（ThreadManager集成）
│   ├── 统一服务注册/注销
│   ├── 统一心跳发送
│   ├── 统一日志记录
│   ├── 钩子方法（on_start/on_stop等）
│   └── 配置管理集成
│
└── 迁移完成的服务器（8个）：
    ├── Central Server ✅
    ├── DB Server ✅
    ├── File Server ✅
    ├── Gateway Server ✅
    ├── Login Server ✅
    ├── Matching Server ✅
    └── Chat Server（待实现）
```

**技术债务偿还统计**：

| 技术债务 | 初始状态 | 当前状态 | 改善程度 | 状态 |
|---------|---------|---------|---------|------|
| TD-001 | 代码重复 | ~2000 行 | ~200 行 | ✅ 已解决 |
| TD-002 | Skynet 集成缺失 | 阶段2 进行中 | 约 66% | 🟡 进行中 |
| TD-003 | ThreadManager 未使用 | 未使用 → 全部使用 | ✅ 已解决 | ✅ |
| TD-004 | 连接池不统一 | 部分统一 | ⚠️ 80% | 🟡 部分完成 |
| TD-005 | 配置管理分散 | 8处 → 1处 | ✅ 已解决 | ✅ |

---

### 遇到的问题与解决

**问题1：Protobuf 符号冲突**

```
问题描述：
├── libmysqlcppconn8-static.a 内置 protobuf 符号
├── 与项目的 protobuf 库冲突
└── 导致链接时 multiple definition 错误

解决方案：
├── 优先查找共享库 libmysqlcppconn8.so
├── 仅在找不到时降级使用静态库
└── 修改 CMakeLists.txt 的库查找逻辑 ✅
```

**问题2：DBConnectionPool 未编译**

```
问题描述：
├── db_connection_pool.cpp 存在但未加入编译
└── 导致链接时 undefined reference

解决方案：
├── 添加 db_connection_pool.cpp 到 db/CMakeLists.txt
└── 添加 resolv 库（ns_initparse 等函数）✅
```

**问题3：ConfigManager 链接错误**

```
问题描述：
├── base_server.cpp 使用 ConfigManager
├── 但各模块未编译 config_manager.cpp
└── 导致 undefined reference to ConfigManager::*

解决方案：
├── 所有使用 base_server.cpp 的模块
├── 都添加 config_manager.cpp 到 SOURCES
└── 6个模块的 CMakeLists.txt 已更新 ✅
```

---

## 🚧 紧急事宜（已更新）

### 已完成 ✅

1. ✅ **解决 2000+ 行代码重复问题** - 已通过 BaseServer 解决
2. ✅ **建立统一配置管理** - ConfigManager 已实现
3. ✅ **统一线程池使用** - ThreadManager 已全面使用
4. ✅ **Skynet 编译与运行问题修复** - 完整编译脚本与修复脚本已加入，cservice/ 和 luaclib/ 已生成
5. ✅ **Gateway → Skynet 直连（C++ 端）实现** - `skynet_client` 已加入 Gateway，CMake 已更新
6. ✅ **中央服务器连接池助手上线** - 已统一匹配服务器连接池和日志输出，消除后续扩展隐患
7. ✅ **ConnectionPool 支持超时与空指针防护** - 避免调用方无限阻塞，并确保队列仅包含有效 Channel

### 当前优先级 🔥

1. **🔥 完成 Lua 端桥接与协议对接**（阶段2 内）
2. **⚠️ 完成连接池统一**（TD-004）- 提升可维护性
3. **📊 建立测试体系并完成 Echo 服务验证**（阶段2 末）

---

## 📉 技术债务追踪

### 高优先级技术债务清单（已更新）

| 编号 | 技术债务 | 影响范围 | 预估工作量 | 优先级 | 状态 | 负责阶段 |
|------|---------|---------|-----------|--------|------|---------|
| TD-001 | 代码重复（2000+行） | 全部 8 个服务器 | 2-3 周 | P0 🔴 | ✅ 已完成 | 阶段 1 |
| TD-002 | Skynet 集成缺失 | 架构完整性 | 3-4 周 | P1 🔴 | 🟡 进行中 | 阶段 2 |
| TD-003 | ThreadManager 未使用 | 代码质量 | 1-2 天 | P2 🟡 | ✅ 已完成 | 阶段 1 |
| TD-004 | 连接池不统一 | 可扩展性 | 2-3 天 | P3 🟡 | 🟡 80%（中央侧 helper 已落地） | 阶段 1/3 |
| TD-005 | 配置管理分散 | 易用性 | 1-2 天 | P4 🟢 | ✅ 已完成 | 阶段 1 |
| TD-006 | EventManager 未使用 | 代码质量 | 2-3 天 | P2 🟡 | ⚪ 待处理 | 阶段 3 |
| TD-007 | 缺少错误处理体系 | 系统稳定性 | 3-4 天 | P2 🟡 | ⚪ 待处理 | 阶段 3 |
| TD-008 | 缺少性能监控 | 可观测性 | 4-5 天 | P2 🟡 | ⚪ 待处理 | 阶段 3 |

---

### 技术债务总览（已更新）

**债务统计**：

```
总技术债务估算：8-12 周
已偿还：3-4 周 (33%)  ✅
剩余：5-8 周 (67%)

按优先级分布：
├── P0（紧急）: 0 项 ✅ 已全部解决
├── P1（高）  : 1 项 - 3-4 周（进行中）
├── P2（中）  : 3 项 - 7-10 天
├── P3（低）  : 1 项 - 1-2 天（部分完成）
└── P4（可选）: 0 项 ✅ 已全部解决
```

**已清除的债务区域** ✅：

```
已重构的文件：
├── src/central/server/central_server.cpp   (~150行 → BaseServer)
├── src/gateway/server/gateway_server.cpp   (~180行 → BaseServer)
├── src/login/server/login_server.cpp       (~140行 → BaseServer)
├── src/db/server/db_server.cpp             (~160行 → BaseServer)
├── src/file/server/file_server.cpp         (~145行 → BaseServer)
├── src/matching/server/matching_server.cpp (~135行 → BaseServer)
└── 所有 main.cpp                           (~240行 → ConfigManager)

总计减少重复代码：~1800 行 ✅
```

**优化成果**：

```
代码量优化：
├── 当前总代码量：~13,000 行（从 ~15,000）
├── 已消除重复：~1,800 行 ✅
├── 剩余重复：~200 行
└── 优化比例：90% ✅

开发效率提升（已验证）：
├── 新增服务器：从 2 天 → 0.5 天 ✅ (减少 75%)
├── Bug 修复：从改 8 处 → 改 1 处 ✅ (减少 87.5%)
└── 代码审查：从 2 小时 → 1 小时 ✅ (减少 50%)
```

---

### 债务偿还计划（已更新）

**已完成（Week 1-3）** ✅：清除核心技术债务

```
阶段 1（Week 1-3）：已完成
├── Week 1: BaseServer 基类 ✅
│   ├── 设计与实现
│   ├── Central Server 迁移示范
│   └── 其他5个服务器迁移
│
├── Week 2: ThreadManager 统一 ✅
│   ├── 修复编译警告和逻辑问题
│   ├── 所有服务器迁移
│   └── 单元测试和性能测试
│
└── Week 3: ConfigManager ✅
    ├── 设计与实现
    ├── BaseServer 集成
    ├── 所有 main.cpp 迁移
    └── 代码审查和文档

债务偿还成果：
├── TD-001（代码重复）：✅ 100% 完成
├── TD-003（ThreadManager）：✅ 100% 完成
├── TD-005（配置管理）：✅ 100% 完成
└── TD-004（连接池）：🟡 50% 完成

技术债务减少：40% → 已完成 ✅
```

**当前进行中（Week 4+）**：Skynet 集成

```
阶段 2（Week 4-7）：进行中 🟡（完成约 66%）
└── 已完成：
    ├─ C++ SkynetBridge / skynet_client 实现并集成到 Gateway
    ├─ Skynet 完整编译（包含 cservice/*.so 与 luaclib/*.so）并解决路径/配置问题
    ├─ 启动/管理/诊断脚本（manage_services.sh, compile_guide.sh, diagnose_skynet.sh, fix_skynet.sh, build_skynet.sh）完备
    ├─ 文档补充（quick_start、troubleshooting、path_fix、config_fix）
    ├─ 中央服务器连接池助手完成，匹配服务器链接信息可统一对外
    └─ ConnectionPool 支持获取超时与空通道过滤，方便 Gateway/Matching 容错

└── 未完成：
    ├─ Lua 端桥接（`cpp_bridge.lua` / `cpp_gateway.lua`）：实现消息解析、Protobuf 支持与服务路由
    ├─ 双向 Protobuf 消息回路验证（C++ → Skynet → C++）
    └─ 示例服务（Echo / player_manager）完整集成与压力测试

Day-by-day（后续重点）:
- Day1-2: 完成 Lua 桥接基础（cpp_bridge.lua）
- Day3-4: 实现 Protobuf 编解码在 Lua 中的接入（或使用 descriptor）
- Day5-7: 完成示例 Echo 服务、集成测试与日志增强
```

---

### 中期目标（Month 3-6）⚪

**阶段 3：架构优化** ⚪ 待开始

```
Week 8-10: 架构优化 ⚪
├── Week 8: 事件系统和错误处理
├── Week 9: 性能监控系统
└── Week 10: 日志增强和测试框架

预期里程碑：
├── ⚪ 系统可观测性完善
├── ⚪ 错误处理体系建立
└── ⚪ 测试覆盖率 >20%
```

**阶段 4：功能实现** ⚪ 待开始

```
Week 11-16: 功能实现（并行）⚪
├── Week 11-14: 炉石传说核心玩法
└── Week 15-16: 网盘高级功能

预期里程碑：
├── ⚪ 核心游戏功能实现
└── ⚪ 网盘功能基本完整
```

---

### 长期目标（Month 6-12）⚪

**阶段 5：部署运维** ⚪ 待开始

```
Week 17-18: 部署运维 ⚪
├── Week 17: Docker 和 CI/CD
└── Week 18: 运维文档和监控

Week 19+: 持续优化 ⚪
├── 性能测试和调优
├── 功能扩展
├── Bug 修复
└── 文档完善
```

---

## 🎯 下一步行动

### 立即开始（本周）

**本周目标（聚焦 Stage2）**：

```
1. 完成 Lua 桥接（cpp_bridge.lua & cpp_gateway.lua） - 3 天
   - 实现 TCP 监听与消息解析（长度+类型+数据）
   - 支持 Protobuf 二进制处理或 JSON 临时替代
   - 基于 game_config 加载必要的地址/端口

2. 在 Gateway 中完善 skynet_client 的使用场景 - 2 天
   - 在 Gateway 收到游戏逻辑消息时，按类型路由到 Skynet
   - 实现简单的同步 send_and_wait 用例（例如 ENTER_GAME）

3. 构建并运行 Echo 示例 - 1 天
   - Lua 端 Echo 服务：接收消息并回显
   - C++ 端测试：发送消息并验证回复
```

**交付物**：
- `skynet_src/service/cpp_bridge.lua`（实现）
- 完整的示例流程文档和测试脚本
- 压力测试初步数据（QPS / Latency）

---

## KPI 指标追踪（已更新）

（保留此前指标，调整进度）

**当前总体进度**：59% ✅（阶段1 100% + 阶段2 66% 的加权）

---

## 🛠️ 工具和资源清单

（保持此前内容）

---

## ❓ 常见问题 FAQ（已更新）

（保持此前内容，已加入更多 Skynet 相关 Q&A）

---

# 开发周报模板

（保持此前模板）

---

## 📊 项目进度总览（更新）

**当前状态（2025年12月）**：

```
整体进度：59% ✅ (阶段1完成，阶段2进行中)

阶段进度：
├── ✅ 阶段 1（代码重构）         - 100% 完成
├── 🟡 阶段 2（Skynet 集成）      - 66% 进行中
├── ⚪ 阶段 3（架构优化）         - 0% 未开始
├── ⚪ 阶段 4（功能实现）         - 0% 未开始
└── ⚪ 阶段 5（部署运维）         - 0% 未开始

关键里程碑：
├── ✅ M1: BaseServer 基类完成
├── ✅ M2: 所有服务器迁移完成
├── ✅ M3: ConfigManager 完成
├── ✅ M4: 阶段1完成
├── 🟡 M5: SkynetBridge C++ 端已实现并集成
├── 🟡 M5.5: 中央服务器连接池助手完成，匹配池信息可统一查询
├── 🟡 M5.6: ConnectionPool 引入超时/空通道防护，保证下游稳定
└── ⚪ M6: 阶段2完成（需 Lua 端与 Protobuf 回路验证）
```

---

**最后更新**: 2025年12月（Connection Pool Timeout Update）  
**文档维护**: 开发团队  
**版本**: v1.3.2


