# 相关文件导览
项目文件及其他格式列表：
[文件编码及格式规范](layout.md)
[cpp代码安全指南](cpp_security.md)


# 序言
本文档只写格式和规范，并做出范例，详细的规范描述及解释请参考其他文档
当一条规范关联不同规范时，会重复列出，以便查阅
本文档脱胎与腾讯c++代码安全指南，腾讯 c++代码规范，并进行了修改和补充（不会列出）

腾讯c++代码安全指南（2024年12月31日整理，后续更新可能不及时）
https://github.com/Tencent/secguide/blob/main/C%2CC%2B%2B%E5%AE%89%E5%85%A8%E6%8C%87%E5%8D%97.md

腾讯 c++代码规范（2007版v1.0）
https://pytlab.github.io/assets/files/%E8%85%BE%E8%AE%AFC++%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83.pdf


# 代码格式
## 缩进
- 程序块要采用缩进风格编写，缩进的空格数为4个
    由开发工具自动生成的代码可能不一致，但如果开发工具可以配置，则应该统一配置缩进为4个空格
- 缩进或者对齐只能使用空格键，不可使用TAB 键
    使用TAB键需要设置 TAB 键的空格数目是4格

## 换行及大括号
- 换行符使用LF
- 类继承时，冒号后不换行
- 构造函数成员初始化列表：冒号后换行，列表中的逗号后换行
- 大括号独占一行（lambda表达式，列表初始化另有规定）
- if、for、do、while 等语句：执行语句只有一行时也要加 {} 并换行
- lambda表达式：前大括号不换行，后大括号独占一行，代码块只有一行时也需要换行
- 列表初始化：前大括号不换行，后大括号独占一行，（应该根据代码长度，决定是否换行）
- 每个 case 都要添加 {}，并换行
```
void func()
{
    doSomething();
}

[](){
    doSomething();
};

switch (a)
{
case 1:
{
    doSomething();
    break;
}
default:
{
    doSomething();
    break;
}
}

```

## 空行
- 相对独立的程序块之间、变量说明之后必须加空行
    以下情况应该是用空行分开：
        函数之间应该用空行分开（两行，注释不占行）
        变量声明应尽可能靠近第一次使用处，避免一次性声明一组没有马上使用的变量
        用空行将代码按照逻辑片断划分

## 空格
- 关键字之后要留空格。
    象const、virtual、inline、case  等关键字之后至少要留一个空格
    像if、for、while  等关键字之后应留一个空格再跟左括号‘（ ’ 
- 函数名之后不要留空格， 紧跟左括号’(’ 
- (之后不要留空格    ) , ; 之前不要留空格
- , 之后要留空格  如Function(x, y, z)
- 如果 ; 不是一行的结束符号后也要留空格 如for (initialization;  condition; update)
- = + - * / % && || 等二元运算符前后要留空格
- ! ++ -- &(取地址，引用)等一元运算符前后不要留空格
- 数组下标运算符[]  成员访问运算符. ->  前后不要留空格
- 三元运算符前后要留空格 如x = a > b ? a : b
```
// 示例
if (a == b && b == c)
{
    doSomething();
}

for (int i = 0; i < 10; ++i)
{
    doSomething();
}

void func(int a, int b)
{
    doSomething();
}

int a[3] = {1, 2, 3};

obj->func();
obj.func();

```

## 代码长度
- 不对代码长度做出限制
- 如果需要对一行代码进行换行，应遵守
    长表达式要在操作符处划分新行，操作符放在新行之首，划分出的新行要进行适当的缩进
    参数列表等逗号分隔的项目，逗号放在新行之首
- 不允许把多个短语句写在一行中，即一行只写一条语句
```
// 不推荐
if (condition) doSomething();

// 推荐
if (condition)
{
    doSomething();
}
```
- 不允许一次性声明多个变量
```
// 不推荐
int a, b, c;

// 推荐
int a;
int b;
int c;
```

## 注释
- 注释应该和代码同时更新，不再有用的注释要删除
- 注释的内容要清楚、明了，不能有二义性
- 尽量避免在注释中使用非常用的缩写或者术语等
- 对于复杂逻辑，函数解释应当进行注释
- 注释的主要目的应该是解释为什么这么做，而不是正在做什么。如果从上下文不容易看出作者的目的，说明程序的可读性本身存在比较大的问题，应考虑对其重构
- 避免非必要的注释（作者目前水平有限，选择不遵守此条，并逐步减少无用注释）
```
// 不推荐
ClassA *pA = new ClassA();  //创建新实例 
delete pA;  //销毁对象
```

### 注释行与注释块选择
- 注释块 /**/，注释行 //
- 大量相关注释应当使用注释块
- 对于复杂逻辑，函数解释应当使用注释块

### 类，函数，变量注释
#### 类声明
- 类声明前，应该列出类的简单解释
- 类功能的简单解释，应该放在类定义上一行
- 类内部逻辑，详细功能解释，成员变量解释应该放在类定义内部第一行，使用注释块进行折叠
- 在类声明时，应该列出类的成员变量的简单解释

#### 类定义
- 类的构造，析构，符号重载，类型转换等函数应该放在类定义的开始位置
- 使用 /******/ 对不同功能的函数进行分区

#### 函数
- 一个函数仅完成一件功能
- 函数声明时，应该列出参数的简单解释（定义长的 放在上一行，短的 放在行尾）
- 函数定义时，应该列出参数的简单解释。放在函数定义上一行（默认析构和构造函数可以省略）
- 函数内部逻辑，详细功能解释，参数解释应该放在函数内部第一行，使用注释块进行折叠

#### 特殊变量
- 对于所有有特殊含义的变量、常量，如果其命名无法自解释的，在声明时都必须加以注释，说明其含义

### 其他注释规范
- 对于重复度较高的代码，可以选择一处进行注释，其他地方应当指出这个注释的位置（格式：请参考 ***/*** 文件 *** 函数）
- 引用自定义头文件时，include处 应做出头文件的简单解释

## 类
### 声明文件
- 源文件头部应进行注释，列出：生成日期、作者、模块目的/功能等
- 类名使用首字母大写的大驼峰命名法，可以使用下划线分割单词
- 类继承时，冒号后不换行
- 尽量显式声明类的构造、拷贝构造、析构和赋值函数
- 对于不需要拷贝构造函数时，应显式地禁止它，避免编译器生成默认的拷贝构造函数
- 成员的定义顺序为：public、protected、private
- 类的成员函数定义在前，成员变量定义在后
- 成员函数与成员变量使用多个权限进行区分（private函数与变量使用两个 private区分）
- 根据功能相关性，逻辑性，将成员或函数分组，组之间使用一行空行分割
- protobuf 生成的类名不做修改
- protobuf 生成的 grpc服务接口名 与 proto 文件接口名相同（首字母大写的大驼峰命名法）
- 构造函数：参数名与成员名相同时，参数名后加下划线区分
    比如引用传递等做参数，与成员强相关时，适合使用相同参数名
```
// 示例
#include "***.h"    // 引用自定义头文件
#include <***.h>

/************************************************************ 
// 模块描述       
// 主要函数及其功能 
    1. ------- 
// 关键历史修改记录，例如发生功能修改，成员变化等简单描述，保留最近三次记录
      <author>  <time>   <version >   <desc> 
      David    96/10/12     1.0     build this moudle   
***********************************************************/ 
class ClassName : public BaseClass
{
public:
    ClassName();
    ClassName(int private_var_);    // 名称相同时，参数名后加下划线
    ~ClassName();
    void up_func1();    // 函数较短时，注释放在行尾
    void up_func2();

    void down_func1();  // 按功能分组
    void down_func2();

private:
    // 私有成员函数
    // 函数较长时，注释放在上一行
    void private_func11111111111111111111111111111111111111111111();

private:
    int private_var;   // 私有成员变量
};
```

### 定义文件
- 类内使用成员时，尽量使用 this-> 成员名（变量，函数等）析构函数除外
- 定义文件所需头文件，应该放在定义文件中
- 函数头部应进行注释，列出：函数的目的/功能、输入参数、输出参数、返回值等
```
// 示例
// 函数功能简单描述
void ClassName::ClassName(int private_var_):
    private_var(private_var_)
{
/*************************************************   
// 函数功能、性能等的描述        
// 输入参数说明，包括每个参数的作 用、取值说明及参数间关系。 
// 函数返回值的说明 
// 其它说明 
*************************************************/
    this->private_var = a;
}
```

### 引用类
include时，自定义文件("") 在前，第三方库文件(<>) 在后
自定义文件 应做出简单解释

## 标识符命名
- 命名尽量使用英文单词，力求简单清楚，避免使用引起误解的词汇和模糊的缩写，使人产生误解
- 常量、宏和模板名采用全大写的方式， 每个单词间用下划线分隔
- 枚举 enum 类型名应以大写字母开头或全部大写
- 类，结构体名使用首字母大写的大驼峰命名法，可以使用下划线分割单词
- 函数名以大写字母开头，且应反映函数功能
- 变量名以小写字母开头
- 自己特有的命名风格，要自始至终保持一致，不可来回变化
- 禁止使用拼音相关，单字母，数字等难以直接理解的命名
- i、j、k作局部循环变量是允许的

## 可读性
- 用括号明确表达式的操作顺序，避免使用默认优先级
    防止阅读程序时产生误解，防止因默认的优先级与设计思想不符而导致程序出错
- 不要编写太复杂 、多用途的复合表达式
- 避免直接使用数字，尽量用有意义的枚举或常量来代替
- 禁止使用难以理解，容易产生歧义的语句，注释

## 变量，结构
- 尽量少使用全局变量，尽量去掉没必要的公共变量
- 尽量使用引用传递实现单例模式，而不是使用全局变量
- 变量，特别是指针变量，被创建之后应当及时把它们初始化
- 对于确定不会改变的变量，应该使用 const 修饰
- 尽量减少没有必要的数据类型默认转换与强制转换
- 仔细设计结构中元素的布局与排列顺序，使结构容易理解、节省占用空间，并减少引起误用现象
- 谨慎使用与程序运行的环境相关的系统函数，代码
- 必须使用某平台api时，应该使用 #ifdef 等方式进行区分

## 其他规范
- 主动使用const，避免使用宏
- 通过值，（智能）指针，或引用适当地取得参数
    对仅用于输入的参数来说
    1. 始终给仅用于输入的指针或引用参数加上const限定符
    2. 最好是通过原始类型（例如：char，float）和可以通过值来复制并且复制成本低的值对象来取得参数
    3. 对其它自定义类型的输入，最好是通过const引用来取得
    对输出或输入/输出参数来说
- 尽量用异常来报告错误
    与错误码相比，要尽量用异常来报告错误。
    对一些无法使用异常的错误，或者一些不属于错误的情况，可以用状态码（status code，例如：返回码，errno）来报告。
    如果不可能或不需要从错误中恢复，那么可以使用其它方法，比如正常或非正常地终止程序
- 局部效率应为全局效率服务，不能因为提高局部效率而对全局效率造成影响
- 通过对系统数据结构的划分与组织的改进，以及对程序算法的优化来提高空间效率
- 循环体内工作量最小化（性能）
    应仔细考虑循环体内的语句是否可以放在循环体之外，使循环体内工作量最小，从而提高程序的时间效率
    在多重循环中，应将最忙的循环放在最内层，这样可以减少CPU切入循环层的次数，从而提高效率
- 尽量避免循环体内含判断语句，应将循环语句置于判断语句的代码块之中（性能）
- 对模块中函数的划分及组织方式进行分析、优化，改进模块中函数的组织结构，提高程序效率
- 尽量使用标准库函数，不要“发明”已经存在的库函数
- 要尽量重用已有的代码，直接调用已有的API
- 过程/函数中动态分配的资源（包括内存、文件等），在过程/函数退出之前要释放
```
以下例子将造成内存泄露 ： 
void Func(void) 
{ 
    char *p = (char *) malloc(128);  

    return ; 
} 
```
- 充分理解new/delete，malloc/free 等指针相关的函数的意义，对指针操作时需小心翼翼
- 防止内存操作越界
- 要时刻注意易混淆的操作符。当编完程序后，应从头至尾检查一遍这些操作符，以防止拼写错误
- 有可能的话，if语句尽量加上else分支，对没有else分支的语句要小心对待；switch 语句必须有default分支
- 禁止使用goto语句，而是优化代码结构，使之不需要goto语句
- 不使用与硬件、操作系统、或编译器相关的语句，而使用建议的标准语句，以提高软件的可移植性和可重用性
    避免会因为编译器优化，系统，硬件等造成不同结果的代码
- 时刻注意表达式左值是否会上溢、下溢
- 使用第三方提供的软件开发工具包或控件时，要注意以下几点
    充分了解应用接口、使用环境及使用时注意事项
    不能过分相信其正确性
    除非必要，不要使用不熟悉的第三方工具包与控件
- 资源文件（多语言版本支持），如果资源是对语言敏感的，应让该资源与源代码文件分离，比如：
    使用单独的资源文件、DLL文件或其它单独的描述文件（如数据库格式）
- 打开编译器的所有告警开关对程序进行编译，并且要尽可能确认、处理所有的编译告警
- 通过代码走读及审查方式对代码进行检查
- 如果可能，单元测试要覆盖98%以上的代码，尽可能早地发现和解决问题
- 尽量使用自动脚本，测试工具等提高代码质量，以及开发速度


# 特殊文件格式
## proto文件
- 遵守大括号换行规则
- 尽量不使用string，而是使用bytes（proto的string是utf-8，与c++会造成冲突）
- map的键类型使用string（无法使用bytes）
- 字段值从1开始


