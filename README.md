# poor_server_stl
c++（无qt库）的服务端版本

本项目用来尝试使用c++标准库重构qt版本的服务端
原项目使用 QT库，在面试和实际工作中发现，很少会使用 QT库作为服务器框架
所以决定使用本项目重构原代码，实现并学习下面功能：
1. 分布式服务器，多线程
2. 服务器之间通信和调用：RPC
3. 客户端与服务器，服务器之间通信协议：protobuf
4. 使用分层架构，多模块设计：各模块独享一个 CMakeLists文件，可以独立编译启动，通过顶级 CMakeLists文件管理
5. 使用对象池管理项目中需要频繁创建删除的对象
6. 结合lua语言实现配置文件等的热更新

# 文件树
tree.txt：文件树（包含其他文件的详细介绍）
vcpkg_json：第三方库文件列表

config/：系统配置文件
protobuf/：各模块 grpc通信 proto协议文件
src/：各模块源码文件
tools/：工具文件
vpckg_installed/：第三方库文件

# 项目中使用的第三方库
所有第三方库文件都放在 vcpkg_installed/x64-windwos 文件夹下（需要使用vcpkg安装后，自动生成）
第三方库的 debug模式的文件，放在 vcpkg_installed/x64-windwos/debug 文件夹下

## 第三方库列表
仅包含直接使用的库列表

### 网络库
boost库

### grpc：客户端与服务器，服务器之间的通信协议
grpc库
实现服务器之间的远程调用

### mysql库
mysql-connector-cpp库
使用mysqlx协议，所以链接数据库的端口是33060

### redis：缓存库
cpp-redis库
tacopie库
redis在windows下构建时，会导致一些异常，所以需要使用类进行包装，然后使用类的方法来操作redis（详见 central_server.h）

### json操作
nlohmann-json库

### protobuf：客户端与服务器，服务器之间的数据序列化
protobuf库：包含在 grpc库中

生成文件用到 protoc编译器，这个文件在 /vcpkg_installed/x64-windows/tools/protobuf/protoc.exe
生成 rpc服务文件时，需要用到 grpc_cpp_plugin.exe，这个文件需要先安装 grpc库，安装后保存在 /vcpkg_installed/x64-windows/tools/grpc/grpc_cpp_plugin.exe

我这里使用 which指令寻找 grpc_cpp_plugin工具时，一直找不到，所以使用的是相对路径
proto 中，string默认是 utf-8格式，与c++冲突，所以在编写 proto文件时，需要使用 bytes代替string


# 各服务器模块功能
## 中心服务器
主要负责管理所有服务器，包括：服务器启停，活动，服务器之间的通信，监控等，还负责全服消息的发送
所有服务器的活动日志，其他服务器还会有自己的日志
_守护其他服务器：中心服务器会定时检查其他服务器的状态，如果发现服务器异常，会自动重启服务器

_心跳：中心服务器会定时向其他服务器发送心跳包，其他服务器收到心跳包后，返回心跳包，
	中心服务器根据心跳包的返回时间，判断服务器是否正常

_连接池：其他服务器使用连接池管理与其他服务器的连接
	其他服务器直接轮询各自的连接池，与其他服务器通信
	每隔一段时间，中心服务器会将最新的服务器列表发送给所有服务器
	其他服务器根据此列表，更新链接池中的连接

## 网关服务器
处理客户端链接，断开
客户端请求通过统一的转发接口，传递服务类型与负载数据包（具体信息）
根据服务类型，将负载反序列为对应请求数据包，然后转发给对应的服务器

## 逻辑服务器
负责处理所有游戏逻辑，包括：战斗，任务，商城等
用户管理：用户数据更新，用户数据存储，用户数据查询等

## 登录服务器
负责处理登录，注册等请求
服务器用户数量管理

## 数据库服务器
负责处理其他服务器对数据库的操作，还负责数据库的备份
_处理数据库的增删改查
其他服务器通过指定数据库名，表名，字段名，条件等，向数据库服务器发送请求，数据库服务器处理后返回数据
其他服务器获取数据后，在自己的服务器中对数据进行逻辑处理

_数据库的备份
定时备份数据库到另一个服务器

_启动时保持数据库的完整性
可能由于配置文件更新，服务器异常等问题，导致数据库数据不完整，所以在启动时，需要检查数据库的完整性
数据缺失时，报出异常，停止服务器启动，等待管理员使用备份数据恢复数据库
自动创建缺失表
自动更新表字段

# 流程
服务器启动流程：
中心服务器启动
其他服务器自行启动，然后向中心服务器注册

服务器守护：
中心服务器向其他服务器发送心跳包，其他服务器返回心跳包
如果发现服务器异常，会自动重启服务器

客户端请求处理：
客户端所有类型的请求，通过客户端统一的接口，传递服务类型与负载数据包
网关服务器根据服务类型，将负载数据包反序列化为对应的请求数据包，然后转发给对应的服务器
服务器处理请求后，返回数据包给网关服务器
网关服务器将数据包序列化后，返回给客户端

特殊处理文件类型服务：
文件上传下载通过特殊接口进行处理：
客户端请求文件上传下载，网关服务器将请求转发给文件服务器
文件服务器处理文件上传下载请求，返回结果（包含文件服务器地址信息）给网关服务器
网关服务器将结果返回给客户端
客户端根据文件服务器地址信息，直接与文件服务器进行文件上传下载