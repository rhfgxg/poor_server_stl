// Skynet 战斗服务协议
// 处理战斗逻辑、回合操作等

syntax = "proto3";
package skynet_proto;

import "skynet_common.proto";

// ==================== 战斗状态 ====================

enum BattlePhase {
    BATTLE_PHASE_UNKNOWN = 0;
    BATTLE_PHASE_MULLIGAN = 1;      // 换牌阶段
    BATTLE_PHASE_MAIN = 2;          // 主阶段
    BATTLE_PHASE_COMBAT = 3;        // 战斗阶段
    BATTLE_PHASE_END_TURN = 4;      // 回合结束
    BATTLE_PHASE_GAME_OVER = 5;     // 游戏结束
}

enum ActionType {
    ACTION_TYPE_UNKNOWN = 0;
    ACTION_TYPE_PLAY_CARD = 1;      // 打出卡牌
    ACTION_TYPE_ATTACK = 2;         // 攻击
    ACTION_TYPE_USE_HERO_POWER = 3; // 使用英雄技能
    ACTION_TYPE_END_TURN = 4;       // 结束回合
    ACTION_TYPE_MULLIGAN = 5;       // 换牌
    ACTION_TYPE_CONCEDE = 6;        // 投降
    ACTION_TYPE_EMOTE = 7;          // 表情
}

// ==================== 战斗数据结构 ====================

// 战斗中的卡牌
message BattleCard {
    string instance_id = 1;     // 战斗中的实例 ID
    string card_id = 2;         // 原始卡牌 ID
    int32 current_attack = 3;
    int32 current_health = 4;
    int32 current_mana = 5;
    bool can_attack = 6;
    bool is_exhausted = 7;      // 已行动
    bool is_frozen = 8;
    bool is_silenced = 9;
    repeated string buffs = 10;
}

// 玩家战斗状态
message PlayerBattleState {
    string player_id = 1;
    int32 current_health = 2;
    int32 max_health = 3;
    int32 armor = 4;
    int32 current_mana = 5;
    int32 max_mana = 6;
    repeated BattleCard hand = 7;       // 手牌
    repeated BattleCard board = 8;      // 场上随从
    int32 deck_count = 9;               // 牌库剩余
    bool hero_power_used = 10;
    BattleCard weapon = 11;             // 装备的武器
}

// 战斗状态
message BattleState {
    string battle_id = 1;
    BattlePhase phase = 2;
    int32 turn_number = 3;
    string current_player_id = 4;
    PlayerBattleState player_state = 5;
    PlayerBattleState opponent_state = 6;
    int32 turn_time_left = 7;           // 回合剩余时间（秒）
}

// ==================== 战斗请求/响应 (500-549) ====================

// 执行战斗动作请求 (type = 500)
message BattleActionRequest {
    string player_id = 1;
    string battle_id = 2;
    ActionType action_type = 3;
    string source_id = 4;       // 来源卡牌/英雄 instance_id
    string target_id = 5;       // 目标 instance_id
    int32 board_position = 6;   // 放置位置（打出随从时）
    repeated int32 mulligan_indices = 7;  // 换牌索引
}

// 执行战斗动作响应 (type = 600)
message BattleActionResponse {
    bool success = 1;
    string message = 2;
    ErrorCode error_code = 3;
    BattleState new_state = 4;
    repeated BattleEvent events = 5;
}

// 获取战斗状态请求 (type = 501)
message GetBattleStateRequest {
    string player_id = 1;
    string battle_id = 2;
}

// 获取战斗状态响应 (type = 601)
message GetBattleStateResponse {
    bool success = 1;
    BattleState state = 2;
}

// 重连战斗请求 (type = 502)
message ReconnectBattleRequest {
    string player_id = 1;
    string battle_id = 2;
}

// 重连战斗响应 (type = 602)
message ReconnectBattleResponse {
    bool success = 1;
    string message = 2;
    BattleState state = 3;
    repeated BattleEvent recent_events = 4;
}

// ==================== 战斗事件 ====================

enum BattleEventType {
    EVENT_UNKNOWN = 0;
    EVENT_CARD_DRAWN = 1;           // 抽牌
    EVENT_CARD_PLAYED = 2;          // 打出卡牌
    EVENT_ATTACK = 3;               // 攻击
    EVENT_DAMAGE = 4;               // 伤害
    EVENT_HEAL = 5;                 // 治疗
    EVENT_DEATH = 6;                // 死亡
    EVENT_BUFF_APPLIED = 7;         // 增益效果
    EVENT_DEBUFF_APPLIED = 8;       // 减益效果
    EVENT_HERO_POWER = 9;           // 英雄技能
    EVENT_TURN_START = 10;          // 回合开始
    EVENT_TURN_END = 11;            // 回合结束
    EVENT_GAME_START = 12;          // 游戏开始
    EVENT_GAME_END = 13;            // 游戏结束
    EVENT_SECRET_TRIGGERED = 14;    // 奥秘触发
    EVENT_FATIGUE = 15;             // 疲劳
}

message BattleEvent {
    BattleEventType event_type = 1;
    string source_id = 2;
    string target_id = 3;
    int32 value = 4;                // 数值（伤害/治疗量等）
    string extra_data = 5;          // 额外数据（JSON）
    int64 timestamp = 6;
}

// ==================== 战斗推送 (650-699) ====================

// 推送战斗状态更新 (type = 650)
message PushBattleStateUpdate {
    string player_id = 1;
    string battle_id = 2;
    BattleState state = 3;
    repeated BattleEvent events = 4;
}

// 推送回合开始 (type = 651)
message PushTurnStart {
    string player_id = 1;
    string battle_id = 2;
    bool is_your_turn = 3;
    int32 turn_number = 4;
    int32 turn_time = 5;
    BattleCard drawn_card = 6;      // 抽到的牌（仅自己回合）
}

// 推送战斗结束 (type = 652)
message PushBattleEnd {
    string player_id = 1;
    string battle_id = 2;
    bool is_winner = 3;
    string reason = 4;              // victory, defeat, concede, disconnect
    BattleReward reward = 5;
}

// 战斗奖励
message BattleReward {
    int32 gold = 1;
    int32 exp = 2;
    int32 rank_change = 3;          // 天梯分数变化
    repeated Achievement achievements = 4;
}

// 推送对手动作 (type = 653)
message PushOpponentAction {
    string player_id = 1;
    string battle_id = 2;
    ActionType action_type = 3;
    BattleEvent event = 4;
}
